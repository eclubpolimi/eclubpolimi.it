---
import MainLayout from "../layouts/main.astro";
import EventTimeline from "./events/EventTimeline.tsx";
import { fetchEventsFromContentful } from "../lib/contentful";
import EventLegend from "../site-components/_Builtin/EventLegend";


const rawEvents = await fetchEventsFromContentful();

const events = (rawEvents ?? [])
  .map((item) => {
    const dateObj = item?.date ? new Date(item.date) : null;
    const isValidDate = dateObj && !isNaN(dateObj.getTime());
    const displayDate = isValidDate
      ? dateObj.toLocaleDateString("en-US", {
          month: "long",
          day: "numeric",
          year: "numeric",
        })
      : (item?.date ?? "TBD");

    return {
      title: item?.title ?? "Untitled Event",
      description: item?.description ?? "",
      date: displayDate,
      year: isValidDate ? dateObj.getFullYear() : 0,
      start: item?.date ?? null,
      end: item?.endDate ?? null,
      extendedProps: {
        description: item?.description ?? "",
        location: item?.location ?? "",
      },
    };
  })
  .filter((e) => e.title && e.date && e.description);
---

<MainLayout>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div>
      <h2 class="text-2xl font-semibold mb-4">Events Calendar</h2>
      <EventLegend/>
      <div class="bg-white rounded-md shadow overflow-hidden">
        <div class="w-full">
          <iframe
            class="w-full h-72 sm:h-96 md:h-[520px] lg:h-[640px]"
            src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Europe%2FRome&showPrint=0&showTabs=0&showNav=0&showTitle=0&showTz=0&src=Y19hYmZiZDJjNTcwMzBhZDAyMDMxZDllM2ZiN2I1YTZmMmQ3M2Q0Zjk1YjRhMGI0MjI0NzA5OWJlZTE0MWY2OWUwQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20&src=Y19lNTA3NjZmNzg0ZjBjYTdmMTE5YjM2NTc0NTc4Y2FkZWE0OGUyMDc2ODAzYTIzYWMyMjJmOWNlODA3YzUzNzc0QGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20&src=Y180NDUyYmM1OGFmZmRmNmM5OTlmNjZlZTg3NGNiZDViNGFhY2RjNTQ1MjkwMGU1YmFjZmE3ZTUzMTc2NGMyOTg5QGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20&color=%23ef6c00&color=%23616161&color=%23d50000"
            style="border:0"
            frameborder="0"
            scrolling="no"
            title="Google Calendar embed"></iframe>
        </div>
      </div>
    </div>

    <div class="mt-12">
      <h2 class="text-2xl font-semibold mb-4">Events Timeline</h2>
      <EventTimeline events={events} client:only="react" />
    </div>
  </div>
</MainLayout>
